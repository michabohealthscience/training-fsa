---
title: "Data processing"
# subtitle: "Data import"
authors: "Michabo Health Science Ltd"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 2
    number_sections: false
link-citations: true
bibliography: references.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Cefic MATCHING metabolomics data set 


The tutorial will use data generated as part of the the **Cefic MATCHING study**, the aim of which was was to conduct a blinded international ring-trial to investigate whether 6 metabolomics labs, each generating, analysing and reporting metabolomics data from a single exposure study (rodent plasma), generate the same grouping hypothesis [@viant2024demonstrating].

![](Phenome-Centre-Birmingham.png){width=300px}

Rather than use all the data from the study, the tutorial will focus only on male rats and the processed mass spectrometry data derived from the data collected as part from one of the ring-trial labs (Phenome Centre Birmingham).

We can unblind at the end of the tutorial (but if you can't wait go straight to the final stage of the tutorial!).

![Figure 1.1. Phenome Centre Birmingham - LC-MS](pcb_ms.png){width=300px}

&nbsp;

# Liquid chromatography mass spectrometry

Mass spectrometry coupled liquid chromatography (in particular high-resolution mass spectrometry with Ultra-high-performance liquid chromatography - UHPLC-MS) is an effective and popular approach for metabolomics and is what was used for data we are using for this tutorial. 

Full details of the methods found in the [supplemental of Cefic MATCHING publication](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10944399/bin/204_2024_3680_MOESM1_ESM.pdf) [@viant2024demonstrating].

The raw data collected from UHPLC-MS and LC-MS more generally can be thought of within 3 dimensions. 

* **Retention time (RT)**: This time at which the metabolites are eluted from the chromatography column based on the physiochemical properties of the metabolite
* **Mass-to-charge (*m/z*) **: The *m/z* of the metabolites that have been ionized to gas-phase ions then separated and detected by the mass spectrometer.
* **Intensity**: The intensity of each *m/z* - proportional to the number of ions detected (note though that without use of reference standards this cannot be directly used as the concentration due to various contributing factors e.g. ion suppression)


![Fig 1.2 LC-MS data](mz_rt_intensity.png){width=400px}

&nbsp;

The UHPLC−MS approach used for our dataset consisited of four assays, comprising of two types of chromatography and two mass spectromety ionisation modes (positive and negative). The chromatographic columns being either a Hydrophilic Interaction Liquid "HILIC" column (primarily to measure polar metabolites) and a C18 column (primarily to measure lipids). These will be referred to as the following from now on:

* HILIC_POS
* HILIC_NEG
* LIPIDS_POS
* LIPIDS_NEG


# Data processing 

Metbolomics data is typically analysed as matrix of **intensities** where one axis is for the **samples** that were analysed and the other for the **features**. Features being a specific *m/z* at a specific retention time.

![Fig 1.3 Feature X sample matrix of intensity](feature_matrix.png){width=400px}
&nbsp;


The full data processing from raw mass spectrometry data to usable omics data matrix for grouping is beyond the scope 
of this tutorial. Instead we will work with a data matrix that has undergone standard processing to create a data matrices required for our analysis.

In brief the following steps were performed:

1. Conversion of the RAW mass spectrometry files to open source mzML format. And centroiding the full profile of the raw data
2. Data reduction: Full scan (MS1) "peak picking", grouping and any rentiontion time correction performed by XCMS software
3. Feature intensity drift and/or batch correction
4. Identification and removal ("filtering") of features 
5. Identification and removal ("filtering") of outlying samples
6. Normalisation: Using PQN median samples as reference (Dieterle et al. 2006)
7. Missing value imputation (for multivaraite analysis only)
9. glog transformations (for multivariate analysis only)


The full details of the data processing methods are found in the [supplemental of Cefic MATCHING publication](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10944399/bin/204_2024_3680_MOESM1_ESM.pdf) [@viant2024demonstrating].

For this part of the tutorial we are going to look at the HILIC_POS assay as an example. And have included data files that contain both the metadata and data matrices for different stages of the data processing workflow for us to assess and then use for grouping.

* **HILIC_POS_male/0_sample_metadata.csv**  - Sample metadata prior to exclusion of any samples
* **HILIC_POS_male/0_sample_metadata_filtered.csv** - Sample metadata with any samples removed
* **HILIC_POS_male/0_feature_metadata.csv** - Feature metdata
* **HILIC_POS_male/1_unfiltered.csv** - unfiltered intensity matrix
* **HILIC_POS_male/2_filtered.csv** - filtered (both samples and features) intensity matrix
* **HILIC_POS_male/3_pqn.csv** - PQN normalised intensity matrix
* **HILIC_POS_male/4_mv_imputed.csv** - missing value imputed intensity matrix
* **HILIC_POS_male/5_glog.csv** - glog intensity matrix


# Reading in the data

Before we read in any data we need to setup where we our getting the data from. If you have downloaded all the tutorial files already the set the working directory.

Otherwise will download the data as we go using the following base URL

```{r root_dir_url}
root <- 'https://raw.githubusercontent.com/michabohealthscience/training-fsa/main'
```


```{r root_dir, echo=FALSE}
root <- '.'
```


## Sample metadata
So... lets finally read in some data. Let's begin with the metadata for the samples

First we read in the the comma seperated file (.csv) using the `read.csv`. This will save
the metadata as a `dataframe` R object.

```{r sample_metadata}
sample_metadata_all <- read.csv(file.path(root, 'data/HILIC_POS_male/0_sample_metadata.csv'))

```


Lets have a quick look at the sample metadata. We can use the `head` function to just see the first few rows

```{r sample_metadata_view}
head(sample_metadata_all)

```
We can use `View(sample_metadata)` in a more user friendly manner within RStudio where you can filter the columns

The following information regarding independent variables for each sample was available prior to unblinding:

* Test substances: TS1, TS2, TS3, TS4, TS5, TS7, TS8, TS9
* Doses: Low (1), High (2)
* Sex: Male

(TS6 was excluded prior to exposures).

Important to note here is that there are QC samples throughout the run. We will touch briefly on this later. All other 
samples are distributed randomly across the run (to help counteract any drift effects across the UHPLC−MS run). 

For each test_substance and dose there should be 5 biological replicates (i.e. 5 samples) for this dataset there is 1 technical replicate for each sample. 

The 'prep order' refers to the preparation of the samples (i.e. metabolite extraction), like the run order, the preparation order should be randomized across the samples to help counteract any bias effect this might have on the metabolite profiles.


## Intensity data



Let's just start with HILIC_POS for now and explore a typical metabolomics dataset. We will be using the pre-filtered and pre-normalisation dataset for this initial check,


```{r hilic_pos_intensity_unfiltered}
hilic_pos_all <- read.csv(file.path(root, 'data/HILIC_POS_male/1_unfiltered.csv'))
```

Again, `head(hilic_pos)` can be used for a quick check and `View(hilic_pos)` can be used to view in more detail.

The first column is a reference to the *m/z* and retention time of a feature and the columns are the samples.

Lets check how many samples and features we have for the study. 

```{r hilic_pos_intensity_cols_rows, results = "hold"}
# feature count
feature_c_all = nrow(hilic_pos_all)
# sample count
samp_c_all = ncol(hilic_pos_all)-1

feature_c_all
samp_c_all

```
We can compare this the the filtered data matrix to see how many features have been removed
```{r hilic_pos_intensity_filtered, results = "hold"}
hilic_pos_f <- read.csv(file.path(root, 'data/HILIC_POS_male/2_filtered.csv'))
```

For this dataset we should see that only 1 sample will be removed (the blank sample - as it is no longer required for furher analysis) and substantial number of the metabolite features will have been removed for subsequent analysis.


```{r hilic_pos_intensity_filtered_cols_rows, results = "hold"}

# feature count
feature_c_f = nrow(hilic_pos_f)
# sample count
samp_c_f = ncol(hilic_pos_f)-1


c('All samples:', samp_c_all)
c('Samples removed:', samp_c_all-samp_c_f)
c('Remaining samples:', samp_c_f)

c('All features:', feature_c_all)
c('Features removed:', feature_c_all-feature_c_f)
c('remaining features:', feature_c_f)
```




## Feature metadata

For each assay there will also be metadata for each feature (this might also include the metabolite annotated to that feature). Due to the complexity of the data and metabolite annotation there can often be alot of metadata associated with each feature 

Lets just check quickly have a look at the *m/z* and RT values!


```{r hilic_pos_feature_metadata}
feature_meta <- read.csv(file.path(root, 'data/HILIC_POS_male/0_feature_metadata.csv'))

# only select a few columns
feature_meta_reduced <- feature_meta[,c(1, 3, 6)]

head(feature_meta_reduced)
```

Now that we understand the processed data we can breifly explain the quality assessments before getting started on the statistical analysis.





# References {-}





